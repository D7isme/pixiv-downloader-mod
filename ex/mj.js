var window=self;
(function(h){function d(){this.movieDesc={w:0,h:0,fps:0,videoStreamSize:0,maxJPEGSize:0};this.avi=d.createAVIStruct();this.headerLIST=d.createHeaderLIST();this.moviLIST=d.createMoviLIST();this.frameList=[]}d.prototype={setup:function(a,b,c){this.movieDesc.w=a;this.movieDesc.h=b;this.movieDesc.fps=c},addCanvasFrame:function(a){var b=atob(a);a=[];for(var c=b.length,e=0;e<c;e++)a[e]=b.charCodeAt(e);a.length%2&&(a[a.length]=0);b=new Uint8Array(a.length);b.set(a);a=new Blob([b],{type:"image/jpeg"});b=
a.size;this.movieDesc.videoStreamSize+=b;this.frameList[this.frameList.length]=a;this.movieDesc.maxJPEGSize<b&&(this.movieDesc.maxJPEGSize=b)},addVideoStreamData:function(a,b){var c=d.createMoviStream();c.dwSize=b.size;c.handler=function(e){e[e.length]=b};a.push(c);return c.dwSize+8},finish:function(a){var b=0;this.moviLIST.aStreams=[];for(var c=this.frameList.length,e=[],f=4,l=["chId","dwFlags","dwOffset","dwLength"],m=0;m<c;m++){var k=this.addVideoStreamData(this.moviLIST.aStreams,this.frameList[m]);
e.push({chId:"00dc",dwFlags:16,dwOffset:f,dwLength:k-8,_order:l});f+=k;b+=k}this.moviLIST.dwSize=b+4;b=Math.floor(1E6/this.movieDesc.fps);f=d.createStreamHeader();f.wRight=this.movieDesc.w;f.wBottom=this.movieDesc.h;f.dwLength=this.frameList.length;f.dwScale=b;c=d.createBitmapHeader();c.dwWidth=this.movieDesc.w;c.dwHeight=this.movieDesc.h;c.dwSizeImage=3*c.dwWidth*c.dwHeight;l=d.createStreamFormat();l.dwSize=c.dwSize;l.sContent=c;c=d.createStreamHeaderLIST();c.dwSize=4+(f.dwSize+8)+(l.dwSize+8);c.aList=
[f,l];f=d.createAVIMainHeader();f.dwMicroSecPerFrame=b;f.dwMaxBytesPerSec=this.movieDesc.maxJPEGSize*this.movieDesc.fps;f.dwTotalFrames=this.frameList.length;f.dwWidth=this.movieDesc.w;f.dwHeight=this.movieDesc.h;f.dwSuggestedBufferSize=0;b=4+(f.dwSize+8);b+=c.dwSize+8;this.headerLIST.dwSize=b;this.headerLIST.aData=[f,c];e={chFourCC:"idx1",dwSize:16*e.length,aData:e,_order:["chFourCC","dwSize","aData"]};b=0+(8+this.headerLIST.dwSize);b+=8+this.moviLIST.dwSize;b+=8+e.dwSize;this.avi.dwSize=b+4;this.avi.aData=
[this.headerLIST,this.moviLIST,e];e=[];d.appendStruct(e,this.avi);a(new Blob(e,{type:"video/avi"}))},build:function(a){d.appendStruct(this.builder,this.avi);var b=this.builder.getBlob("video/avi"),c=window.URL||window.webkitURL;if(c&&(c=c.createObjectURL(b))){a(c);return}var e=new FileReader;e.onload=function(){a(e.result)};e.readAsDataURL(b)}};d.appendStruct=function(a,b,c){c=c||0;if(!b._order)throw"Structured data must have '_order'";for(var e=b._order,f=e.length,l=0;l<f;l++){var m=new ArrayBuffer(4),
k=new Uint8Array(m),p=new ArrayBuffer(2),n=new Uint8Array(p),r=new ArrayBuffer(1),t=new Uint8Array(r),q=e[l],g=b[q];switch(q.charAt(0)){case "b":t[0]=g;a[a.length]=r;break;case "c":a[a.length]=g;break;case "d":k[0]=g&255;k[1]=g>>8&255;k[2]=g>>16&255;k[3]=g>>24&255;a[a.length]=m;break;case "w":n[0]=g&255;n[1]=g>>8&255;a[a.length]=p;break;case "W":n[0]=g>>8&255;n[1]=g&255;a[a.length]=p;break;case "a":m=g.length;for(k=0;k<m;k++)d.appendStruct(a,g[k],c+1);break;case "r":a[a.length]=g;break;case "s":d.appendStruct(a,
g,c+1);break;case "h":g(a);break;default:throw"Unknown data type: "+q;}}};d.createAVIStruct=function(){return{chRIFF:"RIFF",chFourCC:"AVI ",dwSize:0,aData:null,_order:["chRIFF","dwSize","chFourCC","aData"]}};d.createAVIMainHeader=function(){return{chFourCC:"avih",dwSize:56,dwMicroSecPerFrame:66666,dwMaxBytesPerSec:1E3,dwPaddingGranularity:0,dwFlags:16,dwTotalFrames:1,dwInitialFrames:0,dwStreams:1,dwSuggestedBufferSize:0,dwWidth:10,dwHeight:20,dwReserved1:0,dwReserved2:0,dwReserved3:0,dwReserved4:0,
_order:"chFourCC dwSize dwMicroSecPerFrame dwMaxBytesPerSec dwPaddingGranularity dwFlags dwTotalFrames dwInitialFrames dwStreams dwSuggestedBufferSize dwWidth dwHeight dwReserved1 dwReserved2 dwReserved3 dwReserved4".split(" ")}};d.createHeaderLIST=function(){return{chLIST:"LIST",dwSize:0,chFourCC:"hdrl",aData:null,_order:["chLIST","dwSize","chFourCC","aData"]}};d.createMoviLIST=function(){return{chLIST:"LIST",dwSize:0,chFourCC:"movi",aStreams:null,_order:["chLIST","dwSize","chFourCC","aStreams"]}};
d.createMoviStream=function(){return{chType:"00dc",dwSize:0,handler:null,_order:["chType","dwSize","handler"]}};d.createStreamHeaderLIST=function(){return{chLIST:"LIST",dwSize:0,chFourCC:"strl",aList:null,_order:["chLIST","dwSize","chFourCC","aList"]}};d.createStreamFormat=function(){return{chFourCC:"strf",dwSize:0,sContent:null,_order:["chFourCC","dwSize","sContent"]}};d.createStreamHeader=function(){return{chFourCC:"strh",dwSize:56,chTypeFourCC:"vids",chHandlerFourCC:"mjpg",dwFlags:0,wPriority:0,
wLanguage:0,dwInitialFrames:0,dwScale:66666,dwRate:1E6,dwStart:0,dwLength:0,dwSuggestedBufferSize:0,dwQuality:1E4,dwSampleSize:0,wLeft:0,wTop:0,wRight:0,wBottom:0,_order:"chFourCC dwSize chTypeFourCC chHandlerFourCC dwFlags wPriority wLanguage dwInitialFrames dwScale dwRate dwStart dwLength dwSuggestedBufferSize dwQuality dwSampleSize wLeft wTop wRight wBottom".split(" ")}};d.createBitmapHeader=function(){return{dwSize:40,dwWidth:10,dwHeight:20,wPlanes:1,wBitcount:24,chCompression:"MJPG",dwSizeImage:600,
dwXPelsPerMeter:0,dwYPelsPerMeter:0,dwClrUsed:0,dwClrImportant:0,_order:"dwSize dwWidth dwHeight wPlanes wBitcount chCompression dwSizeImage dwXPelsPerMeter dwYPelsPerMeter dwClrUsed dwClrImportant".split(" ")}};d.createMJPEG=function(){return{W_SOI:65496,aSegments:null,W_EOI:65497,_order:["dwSOI","aSegments","dwEOI"]}};d.KnownMarkers={192:"SOF0",196:"DHT",218:"SOS",219:"DQT",221:"DRI",224:"APP0"};h.movbuilder={EjnCmA:d}})(window);var percent=0,builder=new movbuilder.EjnCmA;
onmessage=function(h){h=h.data;if("start"===h.cmd)builder.setup(h.canvasSize.w,h.canvasSize.h,h.fps);else if("frameAdd"===h.cmd){for(var d=Math.round(h.delay/(1E3/h.fps)),a=!0,b=0;b<d;b++)a?(builder.addCanvasFrame(h.imgData),a=!1):builder.addCanvasFrame("");postMessage({cmd:"percent",percent:++percent})}else"finish"===h.cmd&&builder.finish(function(c){postMessage({cmd:"finish",byteArray:c})})};
